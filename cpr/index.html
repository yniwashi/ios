<!doctype html>
<html lang="en">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CPR Timer — Trial</title>
<style>
/* ==========================================================
   CPR TIMER — Patch (2025-09-24 g)
   - WAAFELSS stays under Actions; collapsible
   - Actions: 3 rows × 2 buttons (equal sizing)
   - Log: framed card with header
   - Start/Pause show disabled states and toggle correctly
   - Action button colors updated (light/dark friendly)
   - PDF export via window.open(Blob URL) → footer shows blob:
   - Export .txt removed
   ========================================================== */

/* ---------- Quick customization points ----------
   • Change button colors: adjust CSS vars under :root and :root[data-theme="light"]
   • Change button labels/icons: edit innerText/SVG in HTML below (search “EDIT:”)
-------------------------------------------------- */

:root{
  color-scheme: light dark;
  --bg:#0b0d10; --fg:#e9eef3; --muted:#9aa7b3;
  --card:#14181d; --border:#20262d;
  --shadow: 0 6px 20px rgba(0,0,0,.22);

  /* Total & timer accents */
  --total-color:#f1f5f9;
  --cycle-accent-light:#ff4d4d;
  --cycle-accent-dark:#ffb347;
  --cycle-shadow-light: rgba(255,77,77,.22);
  --cycle-shadow-dark:  rgba(255,179,71,.24);
  --countdown-red:#ff3333;
  --adr-color:#2ea0ff;

  /* Generic button shell */
  --btn-bg:#171b21; --btn-fg:#e9eef3; --btn-bd:#2b333b;

  /* Action button palettes (DARK defaults) */
  --rosc1:#a93a3a; --rosc2:#5a1b1b; --rosc-fg:#fff3f3;            /* light red */
  --stop1:#b11f2a; --stop2:#5a0f14; --stop-fg:#fff3f3;            /* red */
  --shock1:#d6a300; --shock2:#5a4500; --shock-fg:#111;            /* yellow */
  --amio1:#2aa7ff; --amio2:#0a4766; --amio-fg:#ffffff;           /* sky blue */
  --dsed1:#c78c00; --dsed2:#593f00; --dsed-fg:#111;              /* amber (different shade) */
  --export1:#7d5cff; --export2:#2a2166; --export-fg:#ffffff;     /* violet */

  /* Sizes */
  --title-size: clamp(20px, 3.2vw, 36px);
  --subtitle-size: clamp(12px, 1.8vw, 16px);
  --total-size: clamp(40px, 6.2vw, 72px);
  --kpi-digits: clamp(42px, 7.5vw, 110px);
  --chip-h: clamp(36px, 5.2vw, 46px);
  --chip-pad-x: clamp(8px, 1.6vw, 12px);
  --chip-gap: clamp(6px, 1.2vw, 10px);
  --actions-gap: clamp(8px, 1.4vw, 12px);
  --timers-gap: clamp(18px, 3vw, 26px);
  --card-pad: clamp(12px, 2vw, 16px);
  --container-pad: clamp(10px, 2.4vw, 16px);
  --radius: 18px;

--log-font: clamp(12px, 1.2vw, 13px);

  --cycle-accent: var(--cycle-accent-dark);
  --cycle-shadow: var(--cycle-shadow-dark);
}
:root[data-theme="light"]{
  color-scheme: light;
  --bg:#f6f8fc; --fg:#111827; --muted:#4b5563;
  --card:#ffffff; --border:#e5e7eb;
  --btn-bg:#ffffff; --btn-fg:#111827; --btn-bd:#d1d5db;

  /* Action button palettes (LIGHT overrides) */
  --rosc1:#fecaca; --rosc2:#ef4444; --rosc-fg:#7f1d1d;
  --stop1:#ef4444; --stop2:#991b1b; --stop-fg:#ffffff;
  --shock1:#fde047; --shock2:#f59e0b; --shock-fg:#1f2937;
  --amio1:#38bdf8; --amio2:#0284c7; --amio-fg:#ffffff;
  --dsed1:#fbbf24; --dsed2:#b45309; --dsed-fg:#111827;
  --export1:#c4b5fd; --export2:#7c3aed; --export-fg:#ffffff;

  --total-color:#111111;
  --cycle-accent: var(--cycle-accent-light);
  --cycle-shadow: var(--cycle-shadow-light);
}

/* Auto mode: follow device pref when Auto selected */
@media (prefers-color-scheme: light){
  :root:not([data-theme="dark"]){
    color-scheme: light;
    --bg:#f6f8fc; --fg:#111827; --muted:#4b5563;
    --card:#ffffff; --border:#e5e7eb; --btn-bg:#ffffff; --btn-fg:#111827; --btn-bd:#d1d5db;
    --total-color:#111111;
    --cycle-accent: var(--cycle-accent-light);
    --cycle-shadow: var(--cycle-shadow-light);
  }
}

/* Base */
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg)}
.container{max-width:1200px;margin:0 auto;padding:var(--container-pad)}
a{color:inherit}

/* Header */
.header{display:grid;gap:8px}
.controls-row{display:flex;align-items:center;gap:var(--chip-gap);justify-content:space-between;flex-wrap:nowrap}
.brand{justify-self:center;font-weight:900;font-size:var(--title-size);letter-spacing:.2px;text-align:center}
.brand .trial{margin-left:8px;color:#ff3535;font-weight:800;font-size:.55em;white-space:nowrap}

/* Chips */
.chip{display:flex;align-items:center;gap:8px;padding:0 var(--chip-pad-x);height:var(--chip-h);border-radius:14px;background:var(--card);border:1px solid var(--border);color:var(--muted)}
.chip .chip-label{font-weight:800;font-size:var(--subtitle-size);text-transform:uppercase;letter-spacing:.08em}
.chip input[type=number]{width:clamp(64px,10vw,90px);padding:6px 8px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--fg)}

/* Back, Theme, Mute (cardless) */
#backChip,#themeChip,#muteChip{background:transparent;border:none;padding:0}
#backChip .chip-label,#muteChip .chip-label{display:none}

/* Icon toggles */
.icon-toggle{
  display:inline-flex;align-items:center;justify-content:center;
  width:var(--chip-h);height:var(--chip-h);
  border-radius:12px;border:1px solid var(--btn-bd);background:var(--btn-bg);color:var(--fg)
}
.icon-toggle svg{width:clamp(20px,3.4vw,28px);height:clamp(20px,3.4vw,28px)}
/* Back bigger & boxed */
#backBtn.icon-toggle{ width:calc(var(--chip-h) + 6px); height:calc(var(--chip-h) + 6px); font-weight:900; font-size:clamp(22px,3.8vw,32px); line-height:1; }

/* Total CPR */
.total{display:flex;flex-direction:column;align-items:center;margin:8px 0 10px}
.total .label{font-size:var(--subtitle-size);letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:900}
.total .digits{font-variant-numeric:tabular-nums;font-family:ui-monospace,Consolas,monospace;font-weight:900;font-size:var(--total-size);color:var(--total-color)}

/* Layout */
.main{display:grid;gap:16px}
@media (orientation:portrait){
  .main{grid-template-areas:"total" "timers" "actions" "extras"; grid-template-columns:1fr}
  .timers{grid-area:timers; display:grid; gap:var(--timers-gap); justify-items:center; grid-template-columns:repeat(2,minmax(0,1fr));}
  @media (max-width:459.9px){ .timers{grid-template-columns:1fr} }
  .actions{grid-area:actions; display:flex; flex-direction:column; gap:var(--actions-gap); align-items:stretch}
  .extras{grid-area:extras; justify-items:center}
}
@media (orientation:landscape){
  .main{grid-template-areas:"total total total" "timers actions actions" "extras extras extras";
    grid-template-columns:1fr minmax(280px, 420px) 1fr; align-items:start;}
  .actions{grid-area:actions; display:flex; flex-direction:column; gap:var(--actions-gap); align-items:stretch}
  .extras{grid-area:extras}
  .timer .digits{font-size:clamp(38px, 7vw, 96px)}
}

/* Cards */
.centered{display:grid; justify-items:center}
.timer{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:var(--card-pad);display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative; width:min(520px, 100%); box-shadow:var(--shadow)}
.timer .label{font-size:var(--subtitle-size);letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:900;margin-bottom:4px}
.timer .digits{font-variant-numeric:tabular-nums;font-family:ui-monospace,Consolas,monospace;font-weight:900;font-size:var(--kpi-digits)}
#cycleDigits{color:var(--cycle-accent-light)}
#adrDigits{color:#2ea0ff}

/* Metronome flash */
#cycleTimer{ position:relative; }
.cycle-flash{ animation: cycleFlash .18s ease-out 1; }
@keyframes cycleFlash{
  0%{ transform:scale(1); box-shadow:0 0 0 0 rgba(0,0,0,0) }
  15%{ transform:scale(1.04); box-shadow:0 0 0 10px var(--cycle-shadow) }
  100%{ transform:scale(1); box-shadow:0 0 0 0 rgba(0,0,0,0) }
}

/* Icon-ctrl (Start/Pause inside cards) */
.icon-row{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap;justify-content:center}
.icon-ctrl{
  display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;
  border:1px solid var(--btn-bd);background:var(--btn-bg);color:var(--btn-fg);
  transition:opacity .15s, filter .15s
}
.icon-ctrl svg{width:26px;height:26px;fill:currentColor}
.icon-ctrl[disabled]{opacity:.45; filter:grayscale(0.2)}

/* Actions: always 2 buttons per row (ROSC/Stop, Shock/Amio, DSED/Export) */
.actions .row{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap: var(--actions-gap);
  justify-items:stretch;
}

/* Make buttons fill their grid cell and avoid wrapping to a new line */
.actions .row .btn{
  width:100%;
  max-width:none;
  min-width:0;
  flex:none;            /* override any previous flex from older CSS */
}

.btn{appearance:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:clamp(10px,1.6vw,14px) clamp(12px,2vw,18px);border-radius:14px;border:1px solid var(--btn-bd);
  color:var(--btn-fg);font-weight:800;letter-spacing:.2px;box-shadow:var(--shadow);transition:transform .05s}
.btn:active{transform:translateY(1px)}
.btn .ico{width:clamp(16px,2.6vw,22px);height:clamp(16px,2.6vw,22px)}
/* Color variants */
.btn.rosc   {background:linear-gradient(180deg,var(--rosc1),var(--rosc2)); color:var(--rosc-fg)}
.btn.stop   {background:linear-gradient(180deg,var(--stop1),var(--stop2)); color:var(--stop-fg)}
.btn.shock  {background:linear-gradient(180deg,var(--shock1),var(--shock2)); color:var(--shock-fg)}
.btn.amio   {background:linear-gradient(180deg,var(--amio1),var(--amio2)); color:var(--amio-fg)}
.btn.dsed   {background:linear-gradient(180deg,var(--dsed1),var(--dsed2)); color:var(--dsed-fg)}
.btn.export {background:linear-gradient(180deg,var(--export1),var(--export2)); color:var(--export-fg)}

/* Countdown */
#countdown{
  position:absolute;inset:0;display:none;align-items:center;justify-content:center;
  font-family:ui-monospace,Consolas,monospace;font-weight:900; font-size:clamp(80px,14vw,160px);
  color:var(--countdown-red); pointer-events:none; text-shadow:0 2px 10px rgba(0,0,0,.28);
}
#countdown.show{display:flex}
.cycle-hide .label, .cycle-hide #cycleDigits, .cycle-hide .icon-row{ visibility:hidden }

/* Adrenaline prompt */
#adrPrompt{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; font-family:ui-monospace,Consolas,monospace; font-weight:900; font-size:clamp(38px,8vw,96px); color:var(--adr-color); text-align:center; }
#adrTimer.adr-hide .label, #adrTimer.adr-hide #adrDigits, #adrTimer.adr-hide .icon-row{ visibility:hidden }
#adrTimer.adr-show #adrPrompt{ display:flex }

/* Collapsible WAAFELSS (stays under actions) */
details.card{position:relative; background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow)}
summary.wa-summary{
  list-style:none; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;
  padding:12px; font-weight:900; font-size:clamp(18px,2.8vw,20px); user-select:none;
}
summary.wa-summary::-webkit-details-marker{display:none}
.wa-chevron{width:18px; height:18px; transition:transform .18s ease}
details[open] .wa-chevron{ transform:rotate(90deg) }
.wa-divider{height:1px;background:var(--border);margin:4px 0 8px;display:none}
details[open] .wa-divider{display:block}
.wa-content{padding:0 var(--card-pad) var(--card-pad)}
.wa-row{display:flex;justify-content:center;align-items:center;gap:8px;margin-bottom:8px}
.wa-row input{width:clamp(110px,20vw,130px);padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--fg)}
.waffles-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
@media (max-width:520px){.waffles-grid{grid-template-columns:1fr}}
.wrow{display:flex;gap:8px;align-items:center}
.wtag{min-width:110px;padding:6px 10px;border-radius:10px;border:1px solid var(--border);color:var(--muted)}
.wval{font-weight:800}

/* Log card */
.log-card{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); width:min(860px,100%)}
.log-title{padding:10px 14px; font-weight:900; border-bottom:1px solid var(--border); opacity:.9}
.log{max-height:240px;overflow:auto;margin:0;padding:10px 22px; font-family:ui-monospace,Consolas,monospace; font-size:var(--log-font)}
.log li{margin:6px 0}

/* Print */
@media print{
  .header,.controls-row,.actions{display:none!important}
  body{background:#fff;color:#000}
  .timer,.card,.log-card{border:none;box-shadow:none}
  .digits{color:#000}
  details.card summary{display:none}
  details.card .wa-content{display:block}
}
@page{ margin:0 }
</style>
<meta name="theme-color" content="#0b0d10" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#f6f8fc" media="(prefers-color-scheme: light)">
<body>
<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="controls-row" id="controlsRow">
      <div class="chip" id="backChip">
        <div class="chip-label"></div>
        <!-- EDIT: Back icon -->
        <button id="backBtn" class="icon-toggle" title="Back">←</button>
      </div>
      <div class="chip" id="themeChip">
        <div class="chip-label">Theme</div>
        <button id="themeBtn" class="icon-toggle" title="Theme: Auto">Auto</button>
      </div>
      <div class="chip" id="bpmChip">
        <div class="chip-label">BPM</div>
        <input id="bpm" type="number" min="60" max="160" step="1" placeholder="110">
      </div>
      <div class="chip" id="muteChip">
        <div class="chip-label">Mute</div>
        <button id="muteBtn" class="icon-toggle" title="Beat mute/unmute" aria-pressed="false">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 9v6h4l5 4V5L7 9H3z" stroke="currentColor" stroke-width="2"/>
            <path id="wave" d="M15 8c1.8 1.2 3 3 3 5s-1.2 3.8-3 5" stroke="currentColor" stroke-width="2" opacity="1"/>
            <path id="muteX" d="M16 9l5 6M21 9l-5 6" stroke="currentColor" stroke-width="2" opacity="0"/>
          </svg>
        </button>
      </div>
    </div>
    <div class="brand">CPR Timer <span class="trial">Trial Version</span></div>
  </div>

  <!-- Total CPR Time -->
  <div class="total">
    <div class="label">TOTAL CPR TIME</div>
    <div id="totalDigits" class="digits">00:00</div>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="timers">
      <!-- CYCLE -->
      <div id="cycleTimer" class="timer centered" style="margin-bottom:var(--timers-gap)">
        <div class="label">CYCLE</div>
        <div id="cycleDigits" class="digits">00:00</div>
        <div id="countdown">10</div>
        <div class="icon-row">
          <!-- EDIT: Start icon/text -->
          <button id="cprStart" class="icon-ctrl" title="Start/Resume CPR">
            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg><span>Start</span>
          </button>
          <!-- EDIT: Pause icon/text -->
          <button id="cprPause" class="icon-ctrl" title="Pause CPR" disabled>
            <svg viewBox="0 0 24 24"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg><span>Pause</span>
          </button>
        </div>
      </div>

      <!-- ADRENALINE -->
      <div id="adrTimer" class="timer centered">
        <div class="label">ADRENALINE</div>
        <div id="adrDigits" class="digits">00:00</div>
        <div id="adrPrompt">Give Adrenaline</div>
        <div class="icon-row">
          <button id="adrStart" class="icon-ctrl" title="Start/Resume Adrenaline">
            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg><span>Start</span>
          </button>
          <button id="adrPause" class="icon-ctrl" title="Pause Adrenaline" disabled>
            <svg viewBox="0 0 24 24"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg><span>Pause</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Actions (3 rows × 2 buttons) -->
    <div class="actions">
      <div class="row">
        <button id="roscb" class="btn rosc">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M12 21C12 21 4 14 4 9a4 4 0 0 1 8 0 4 4 0 0 1 8 0c0 5-8 12-8 12Z" stroke="currentColor" stroke-width="2"/></svg>
          ROSC
        </button>
        <button id="stopb" class="btn stop">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><rect x="6" y="6" width="12" height="12" rx="2" stroke="currentColor" stroke-width="2"/></svg>
          Stop
        </button>
      </div>
      <div class="row">
        <button id="shockb" class="btn shock">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M13 2 L3 14h7l-1 8 10-12h-7z" stroke="currentColor" stroke-width="2"/></svg>
          Shock
        </button>
        <button id="amiob" class="btn amio">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M12 3v18M5 10h14" stroke="currentColor" stroke-width="2"/></svg>
          Amiodarone
        </button>
      </div>
      <div class="row">
        <button id="dsedb" class="btn dsed" title="Log DSED">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M4 12h16M12 4v16" stroke="currentColor" stroke-width="2"/></svg>
          Log DSED
        </button>
        <button id="printPdf" class="btn export">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M7 17h10v4H7zM7 7V3h10v4M6 13h12a3 3 0 0 0 0-6H6a3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/></svg>
          Export PDF
        </button>
      </div>
    </div>
<!-- Small popover menu for PDF actions -->
<div id="pdfMenu" style="position:absolute; display:none; z-index:9999;">
  <div id="pdfMenuInner" style="
    background:var(--card); border:1px solid var(--border); border-radius:12px;
    box-shadow:var(--shadow); padding:8px; display:flex; gap:8px;
  ">
    <button id="pdfView" class="btn ghost" type="button">View PDF</button>
    <button id="pdfSave" class="btn primary" type="button">Save PDF</button>
  </div>
</div>

    <!-- Extras (WAAFELSS + Log) -->
    <div class="extras" style="display:grid;gap:12px;justify-items:center">
      <!-- WAAFELSS collapsible stays here under actions -->
      <details id="waPanel" class="card" style="width:min(860px,100%)">
        <summary class="wa-summary">
          <span>WAAFELSS</span>
          <svg class="wa-chevron" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" fill="none"/></svg>
        </summary>
        <div class="wa-divider"></div>
        <div class="wa-content">
          <div class="wa-row">
            <input id="age" type="number" min="0" placeholder="Enter Age">
            <button id="mBtn" class="btn" style="background:var(--btn-bg);color:var(--btn-fg)" title="Months" disabled>Months</button>
            <button id="yBtn" class="btn" style="background:var(--btn-bg);color:var(--btn-fg)" title="Years" disabled>Years</button>
          </div>
          <div class="waffles-grid">
            <div class="wrow"><div class="wtag">Age</div><div id="wAge" class="wval">—</div></div>
            <div class="wrow"><div class="wtag">Weight</div><div id="wWeight" class="wval">—</div></div>
            <div class="wrow"><div class="wtag">Adrenaline</div><div id="wAdr" class="wval">—</div></div>
            <div class="wrow"><div class="wtag">Amiodarone</div><div id="wAmio" class="wval">—</div></div>
            <div class="wrow"><div class="wtag">Fluids</div><div id="wFluids" class="wval">—</div></div>
            <div class="wrow"><div class="wtag">SGA</div><div id="wSGA" class="wval">—</div></div>
            <div class="wrow"><div class="wtag">Energy</div><div id="wJoules" class="wval">—</div></div>
            <div class="wrow"><div class="wtag">D10%</div><div id="wD10" class="wval">—</div></div>
          </div>
        </div>
      </details>

      <!-- Log with frame -->
      <div class="log-card">
        <div class="log-title">Event Log</div>
        <ul id="log" class="log"></ul>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
/* ===== THEME ===== */
const root = document.documentElement;
const themeBtn = document.getElementById('themeBtn');
let themeMode = 'auto';
function applyTheme(){
  root.removeAttribute('data-theme');
  if (themeMode==='light') root.setAttribute('data-theme','light');
  if (themeMode==='dark')  root.setAttribute('data-theme','dark');
  themeBtn.textContent = themeMode[0].toUpperCase()+themeMode.slice(1);
  themeBtn.title = `Theme: ${themeBtn.textContent}`;
  const meta = document.querySelector('meta[name="theme-color"]')
    || (()=>{const m=document.createElement('meta');m.setAttribute('name','theme-color');document.head.appendChild(m);return m;})();
  requestAnimationFrame(()=>{
    const bg = getComputedStyle(root).getPropertyValue('--bg').trim() || '#0b0d10';
    meta.setAttribute('content', bg);
  });
}
themeBtn.addEventListener('click', () => {
  themeMode = themeMode==='auto' ? 'light' : themeMode==='light' ? 'dark' : 'auto';
  applyTheme();
});
const mql = window.matchMedia('(prefers-color-scheme: dark)');
mql.addEventListener?.('change', ()=>{ if(themeMode==='auto') applyTheme(); });
applyTheme();

/* ===== NAV ===== */
const HOME = "https://shortcuts.niwashibase.com/helpers/shortcuts_menu.html";
const backBtn = document.getElementById('backBtn');
if(backBtn){
  backBtn.addEventListener('click',()=>{
    if (document.referrer && document.referrer !== location.href) history.back();
    else location.href = HOME;
  });
}

/* ===== HELPERS ===== */
const $ = id => document.getElementById(id);
const fmt = s => { s=Math.max(0,Math.floor(s)); const m=String((s/60|0)).padStart(2,'0'); return `${m}:${String(s%60).padStart(2,'0')}`; };
const hhmmss = d => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false});
const logEl = $('log');
const events = [];
function stamp(label){
  const ts=new Date();
  const li=document.createElement('li');
  li.textContent=`${hhmmss(ts)} | ${label}`;
  logEl.prepend(li);
  events.push({ts,label});
}

   // Dynamically load jsPDF + autoTable once (CDN). Safe to call multiple times.
let __pdfLibLoaded = false;
async function ensureJsPDF(){
  if(__pdfLibLoaded) return;
  const add = (src)=>new Promise((res,rej)=>{
    const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s);
  });
  // jsPDF core
  await add('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
  // autoTable plugin (tables)
  await add('https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js');
  __pdfLibLoaded = true;
}

/* ===== WAKE LOCK ===== */
let wakeLock=null;
async function requestWake(){try{ if('wakeLock' in navigator){wakeLock=await navigator.wakeLock.request('screen');}}catch{}}
async function releaseWake(){try{ if(wakeLock){await wakeLock.release(); wakeLock=null;}}catch{}}
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && (cprRunning||adrRunning)) requestWake(); });

/* ===== AUDIO ===== */
let audioCtx;
const buffers={}, files={
  beat:'beat.wav', start:'start.wav', pause:'pause.wav', stop:'stop.wav',
  adr4:'adr4.wav', total20:'total20.wav', cpr90:'cpr90.wav', cpr120:'cpr120.wav', rosc:'rosc.wav'
};
function primeAudio(){
  if(!audioCtx){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    audioCtx.resume();
    (async()=>{ for(const [k,p] of Object.entries(files)){ try{ const b=await fetch(p).then(r=>r.arrayBuffer()); buffers[k]=await audioCtx.decodeAudioData(b);}catch{} } })();
  }
}
window.addEventListener('pointerdown', primeAudio, {once:true});
window.addEventListener('keydown', primeAudio, {once:true});
function play(name, vol=1){ const buf=buffers[name]; if(!audioCtx || !buf) return; const src=audioCtx.createBufferSource(), g=audioCtx.createGain(); g.gain.value=vol; src.buffer=buf; src.connect(g).connect(audioCtx.destination); src.start(); }

/* ===== METRONOME ===== */
let beatMuted=false, beatTimer=null, bpm=+($('bpm').value||110);
$('muteBtn').addEventListener('click',()=>{
  beatMuted=!beatMuted;
  const mx=document.getElementById('muteX'), wv=document.getElementById('wave');
  if(mx) mx.style.opacity=beatMuted?'1':'0';
  if(wv) wv.style.opacity=beatMuted?'0':'1';
  if(beatMuted) stopBeat(); else if(cprRunning) startBeat();
});
$('bpm').addEventListener('change',e=>{ bpm=+e.target.value||110; if(cprRunning) restartBeat(); });

function flashCycle(){ const card=$('cycleTimer'); if(!card) return; card.classList.remove('cycle-flash'); void card.offsetWidth; card.classList.add('cycle-flash'); }
function startBeat(){ clearInterval(beatTimer); const iv=Math.max(200,60000/Math.max(1,bpm)); beatTimer=setInterval(()=>{ if(!beatMuted) play('beat',0.95); flashCycle(); }, iv); }
function stopBeat(){ clearInterval(beatTimer); beatTimer=null; }
function restartBeat(){ stopBeat(); startBeat(); }

/* ===== STATE ===== */
let totalStart=0,totalEnd=0;
let cprStart=0,cprPausedAt=0,cprPausedAccum=0,cprRunning=false;
let adrStart=0,adrPausedAt=0,adrPausedAccum=0,adrRunning=false,adrCount=0;
let cue20=false, cue90=false, cue120=false;
let cycleCount = 0;
let counting=false, countdownTimer=null, countdownN=10;
let showTotalZero = true;

/* ===== Countdown ===== */
function showCountdown(){
  if(counting) return;
  counting=true; countdownN=10;
  const box=$('countdown'); const card=$('cycleTimer');
  box.textContent=countdownN; box.classList.add('show');
  card.classList.add('cycle-hide');
  stopBeat();
  countdownTimer = setInterval(()=>{
    countdownN--;
    if (countdownN>0){
      box.textContent = countdownN;
    } else {
      clearInterval(countdownTimer); countdownTimer=null;
      box.classList.remove('show'); card.classList.remove('cycle-hide');
      cprStart = Date.now(); cprPausedAccum=0; cprPausedAt=0; cue90=false; cue120=false; cprRunning=true; play('start'); if(!beatMuted) startBeat();
      // Start running → disable Start, enable Pause (visual)
      $('cprStart').disabled = true;
      $('cprPause').disabled = false;
      counting=false;
    }
  },1000);
}
function now(){ return Date.now(); }

/* ===== Animation loop ===== */
function tick(){
  const t=now();

  // Total CPR display
  if(showTotalZero){
    $('totalDigits').textContent='00:00';
  }else if(totalStart && !totalEnd){
    $('totalDigits').textContent=fmt((t-totalStart)/1000);
    if(!cue20 && (t-totalStart)>=20*60000){ cue20=true; play('total20'); }
  }else if(totalStart && totalEnd){
    $('totalDigits').textContent=fmt((totalEnd-totalStart)/1000);
  }else{
    $('totalDigits').textContent='00:00';
  }

  // Cycle 2:00 → countdown
  let c=0;
  if(cprStart){
    if(cprRunning) c=(t-cprStart-cprPausedAccum)/1000;
    else if(cprPausedAt) c=(cprPausedAt-cprStart-cprPausedAccum)/1000;
    else if(totalEnd) c=(totalEnd-cprStart-cprPausedAccum)/1000;
    c = c|0;
    if(!counting){ $('cycleDigits').textContent=fmt(c); }

    if(!cue90 && c>=90){ cue90=true; play('cpr90'); }
    if(!cue120 && c>=120){
      cue120=true; play('cpr120');
      cycleCount += 1;
      stamp(`Cycle ${cycleCount} finished`);
      cprRunning=false;
      // running → paused state
      $('cprStart').disabled = false;
      $('cprPause').disabled = true;
      showCountdown();
    }
  }else if(!counting){
    $('cycleDigits').textContent='00:00';
  }

  // Adrenaline 4:00 loop (+stamp at each 4:00)
  if(adrStart){
    let a=0;
    if(adrRunning) a=(t-adrStart-adrPausedAccum)/1000;
    else if(adrPausedAt) a=(adrPausedAt-adrStart-adrPausedAccum)/1000;
    else if(totalEnd) a=(totalEnd-adrStart-adrPausedAccum)/1000;
    a = a|0;

    if(a>=240){
      $('adrDigits').textContent='04:00'; play('adr4');
      adrCount++; stamp(`Adrenaline no. ${adrCount} Administered`);
      const adrCard=$('adrTimer'); adrCard.classList.add('adr-hide','adr-show');
      adrRunning = false;
      // switch to paused look
      $('adrStart').disabled = false;
      $('adrPause').disabled = true;
      setTimeout(()=>{
        adrCard.classList.remove('adr-show','adr-hide');
        adrStart=now(); adrPausedAccum=0; adrPausedAt=0; adrRunning=true;
        // resume running look
        $('adrStart').disabled = true;
        $('adrPause').disabled = false;
      }, 2000);
      a=0;
    }
    $('adrDigits').textContent=fmt(a);
  }else{
    $('adrDigits').textContent='00:00';
  }

  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

/* ===== Controls (toggle disabled visuals) ===== */
$('cprStart').onclick = () => {
  primeAudio();
  if(!totalStart){
    totalStart=now(); totalEnd=0; showTotalZero=false;
    stamp('CPR Timer Started'); requestWake();
  }
  if(!cprStart){ cprStart=totalStart; cprPausedAccum=0; cue90=false; cue120=false; play('start'); }
  else if(cprPausedAt){ cprPausedAccum += (now()-cprPausedAt); cprPausedAt=0; play('start'); stamp('CPR Timer Resumed'); }
  cprRunning=true; $('cprPause').disabled=false; if(!beatMuted) startBeat();
  // running look
  $('cprStart').disabled = true;
};
$('cprPause').onclick = () => {
  if(!cprRunning) return; primeAudio();
  cprRunning=false; cprPausedAt=now(); play('pause'); stamp('CPR Timer Paused'); stopBeat();
  // paused look
  $('cprStart').disabled = false;
  $('cprPause').disabled = true;
};
$('adrStart').onclick = () => {
  primeAudio(); if(!totalStart) $('cprStart').click();
  if(!adrStart){
    adrStart=now(); adrPausedAccum=0; adrPausedAt=0; adrRunning=true;
    adrCount++; stamp(`Adrenaline no. ${adrCount} Administered`);
    stamp('Adrenaline Timer Started');
  } else if(adrPausedAt){
    adrPausedAccum += (now()-adrPausedAt); adrPausedAt=0; adrRunning=true; stamp('Adrenaline Timer Resumed');
  }
  $('adrPause').disabled=false;
  $('adrStart').disabled=true; // running look
};
$('adrPause').onclick = () => {
  if(!adrRunning) return; adrRunning=false; adrPausedAt=now(); stamp('Adrenaline Timer Paused');
  $('adrStart').disabled=false; $('adrPause').disabled=true; // paused look
};

function endSession(label){
  primeAudio();
  if(!totalStart) return;
  if(!totalEnd) totalEnd = now();
  stamp(label);
  if(cprRunning){ cprRunning=false; cprPausedAt=0; }
  cprStart=0; cprPausedAccum=0; cue90=false; cue120=false; counting=false;
  const cd=$('countdown'); if(cd) cd.classList.remove('show'); $('cycleTimer').classList.remove('cycle-hide');
  if(adrRunning){ adrRunning=false; adrPausedAt=0; }
  adrStart=0; adrPausedAccum=0;
  showTotalZero = true;
  stopBeat(); releaseWake();
  // Reset button looks
  $('cprStart').disabled=false; $('cprPause').disabled=true;
  $('adrStart').disabled=false; $('adrPause').disabled=true;
}
$('stopb').onclick = () => { play('stop'); endSession('CPR Timer Stopped'); };
$('roscb').onclick = () => { play('rosc'); stamp('ROSC Achieved'); endSession('CPR Timer Stopped'); };
$('shockb').onclick = () => { window.__shock=(window.__shock||0)+1; stamp(`Shock no. ${window.__shock} Delivered`); };
$('amiob').onclick  = () => { window.__amio =(window.__amio ||0)+1; stamp(`Amiodarone no. ${window.__amio} Administered`); };
$('dsedb').onclick  = () => { stamp('DSED Delivered'); };

/* ===== Export PDF (window.open with Blob URL → footer shows blob:) ===== */
(function setupPdfMenu(){
  const menu = document.getElementById('pdfMenu');
  const menuInner = document.getElementById('pdfMenuInner');
  const exportBtn = document.getElementById('printPdf');
  const viewBtn = document.getElementById('pdfView');
  const saveBtn = document.getElementById('pdfSave');

  // Build PDF (returns a Blob)
  async function buildPdfBlob(){
    await ensureJsPDF();
    const { jsPDF } = window.jspdf;

    // Create doc (A4 portrait)
    const doc = new jsPDF({ unit:'pt', format:'a4' });

    // Theme-ish colors
    const accent = [46,160,255]; // matches your table accent
    const fg     = [30, 41, 59];

    // Header
    doc.setFont('helvetica','bold'); doc.setFontSize(18);
    doc.setTextColor(fg[0],fg[1],fg[2]);
    doc.text('CPR Session Report', 40, 52);

    // KVs
    const started = totalStart ? new Date(totalStart).toLocaleString([], {hour12:false}) : 'N/A';
    const ended   = totalEnd ? new Date(totalEnd).toLocaleString([], {hour12:false})   : 'N/A';
    const total   = (totalStart && totalEnd) ? fmt((totalEnd-totalStart)/1000) : '—';
    const counts  = `Adrenaline: ${adrCount}; Shocks: ${window.__shock||0}; Amiodarone: ${window.__amio||0}`;

    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    let y = 80;
    const kvs = [
      ['Started', started],
      ['Ended',   ended],
      ['Total',   total],
      ['Counts',  counts],
    ];
    kvs.forEach(([k,v])=>{
      doc.setFont('helvetica','bold');   doc.text(k+':', 40, y);
      doc.setFont('helvetica','normal'); doc.text(String(v), 120, y);
      y += 18;
    });

    // Events table data
    const rows = events.map(e => [ hhmmss(e.ts), e.label ]);

    // autoTable (striped look similar to your HTML)
    doc.autoTable({
      startY: y + 12,
      head: [['Time (24h)','Event']],
      body: rows,
      theme: 'striped',
      headStyles: { fillColor: accent, textColor: 255, fontStyle:'bold' },
      styles:     { font:'helvetica', fontSize: 11, cellPadding: 6 },
      alternateRowStyles: { fillColor: [240,248,255] }, // very light
      columnStyles: { 0: { cellWidth: 120 } }
    });

    // Footer (same text you used in HTML report)
    const pageCount = doc.getNumberOfPages();
    for(let i=1; i<=pageCount; i++){
      doc.setPage(i);
      const w = doc.internal.pageSize.getWidth();
      const h = doc.internal.pageSize.getHeight();
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.setTextColor(120,120,130);
      doc.text('Ambulance App', w/2, h-18, { align:'center' });
    }

    // Return a Blob so we can open or save via blob: URL
    return doc.output('blob');
  }

  // Position the popover under the Export button
  function showMenu(){
    const r = exportBtn.getBoundingClientRect();
    const scrollY = window.scrollY || document.documentElement.scrollTop;
    const scrollX = window.scrollX || document.documentElement.scrollLeft;
    menu.style.left = (scrollX + r.left + (r.width/2) - (menuInner.offsetWidth/2 || 100)) + 'px';
    menu.style.top  = (scrollY + r.bottom + 8) + 'px';
    menu.style.display = 'block';
    // Click-away to close
    const close = (ev)=>{
      if(!menu.contains(ev.target) && ev.target !== exportBtn){
        menu.style.display='none';
        document.removeEventListener('click', close);
      }
    };
    setTimeout(()=>document.addEventListener('click', close), 0);
  }

  exportBtn.onclick = (e)=>{ e.preventDefault(); showMenu(); };

  // View: open in a new tab (blob: URL shows in Safari footer)
  viewBtn.onclick = async ()=>{
    menu.style.display='none';
    const blob = await buildPdfBlob();
    const url  = URL.createObjectURL(blob); // blob:… keeps your real URL hidden
    window.open(url, '_blank');
    // Do NOT revoke immediately; let the user view it. You can revoke it later if you track the window.
  };

  // Save: trigger a download (still blob:)
  saveBtn.onclick = async ()=>{
    menu.style.display='none';
    const blob = await buildPdfBlob();
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cpr_report_${new Date().toISOString().replace(/[:.]/g,'-')}.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    // Safe to revoke shortly after download click
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  };
})();

/* ===== WAAFELSS enable/compute ===== */
const age=$('age'), mBtn=$('mBtn'), yBtn=$('yBtn');
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function months(n){
  const weight=n*0.5+4, adr=+(weight*0.01).toFixed(2), amio=+(weight*5).toFixed(1);
  const minF=Math.round(weight*10), maxF=Math.round(weight*20);
  const joules=Math.round(clamp(weight*4,0,360)), d10=+(clamp(weight*2.5,0,50)).toFixed(1);
  const sga=(weight<=5)?'Size 1':'Size 1.5';
  return {age:`${n} months`,weight,adr,amio,minF,maxF,sga,joules,d10};
}
function years(n){
  let weight,sga; if(n<=5){weight=n*2+8; sga=(weight>=10&&weight<=24)?'Size 2':(weight>=25&&weight<=35)?'Size 2.5':'';}
  else{weight=n*3+7; sga=(weight>=25&&weight<=35)?'Size 2.5':'Consider adult SGA sizes';}
  const adr=+(weight*0.01).toFixed(2), amio=+(weight*5).toFixed(1);
  const minF=Math.round(weight*10), maxF=Math.round(weight*20);
  const joules=Math.round(clamp(weight*4,0,360)), d10=+(clamp(weight*2.5,0,50)).toFixed(1);
  return {age:`${n} years`,weight,adr,amio,minF,maxF,sga,joules,d10};
}
function renderW(o){
  $('wAge').textContent=o.age;
  $('wWeight').textContent=`${o.weight.toFixed(1)} kg`;
  $('wAdr').textContent=`${o.adr} mg`;
  $('wAmio').textContent=`${o.amio} mg`;
  $('wFluids').textContent=`${o.minF}–${o.maxF} mL`;
  $('wSGA').textContent=o.sga||'—';
  $('wJoules').textContent=`${o.joules} J`;
  $('wD10').textContent=`${o.d10} mL`;
}
function validAge(){ const n=+age.value; return !(isNaN(n) || n<0); }
function checkAge(){ const empty = (age.value===''||age.value===null); mBtn.disabled=empty; yBtn.disabled=empty; }
age.addEventListener('input',checkAge); checkAge();

mBtn.onclick = ()=>{ if(!validAge()){ alert('Enter age first'); return; } renderW(months(+age.value)); };
yBtn.onclick = ()=>{ if(!validAge()){ alert('Enter age first'); return; } renderW(years(+age.value)); };

/* ===== Self-tests ===== */
(function runSelfTests(){
  console.assert(!document.getElementById('countdown').classList.contains('show'), 'countdown hidden initially');
})();
})();
</script>
</body>
</html>
