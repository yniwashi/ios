<!doctype html>
<html lang="en">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CPR Timer — Trial</title>

<style>
/* ==========================================================
   CPR TIMER — Compact & Centered (Portrait + Landscape)
   - Tight Total CPR header
   - Minimal timer chrome (no cards), large digits
   - Smaller action buttons; dense spacing
   - Robust overlay centering (countdown / Give Adrenaline)
   ========================================================== */

/* ---------- THEME TOKENS ---------- */
:root{
  color-scheme: light dark;
  --bg:#0b0d10; --fg:#e9eef3; --muted:#9aa7b3;
  --card:#14181d; --border:#20262d;
  --btn-bg:#171b21; --btn-fg:#e9eef3; --btn-bd:#2b333b;

  --rosc-1:#fb8686; --rosc-2:#f52a2a; --rosc-bd:#ff5050;
  --stop-1:#C62828; --stop-2:#8E1E1E; --stop-bd:#A12222;
  --shock-1:#ffe79d; --shock-2:#ffd878; --shock-bd:#ffdb7d;
  --amio-1:#2EA0FF; --amio-2:#1976D2; --amio-bd:#1E88E5;
  --dsed-1:#ff5e4e; --dsed-2:#ff9f3e; --dsed-bd:#f7ac56;
  --export-1:#1fa367; --export-2:#1cd958; --export-bd:#10b168;

  --wa-m-1:#f26bfb; --wa-m-2:#e129ed; --wa-m-bd:#e52ff1;
  --wa-y-1:#00BFA6; --wa-y-2:#008F79; --wa-y-bd:#00A68F;

  /* Sizes tuned to keep things in view on phones */
  --title-size: clamp(18px, 2.6vw, 32px);
  --subtitle-size: clamp(12px, 1.6vw, 15px);
  --total-size: clamp(36px, 6vw, 64px);
  --kpi-digits: clamp(56px, 11vw, 132px);

  /* Tighter gaps to keep buttons on-screen */
  --gap-xs: clamp(6px, 1vw, 8px);
  --gap-sm: clamp(8px, 1.4vw, 10px);
  --gap-md: clamp(10px, 1.8vw, 14px);
  --gap-lg: clamp(12px, 2.6vw, 18px);

  --chip-h: clamp(32px, 4.8vw, 42px);
  --chip-pad-x: clamp(8px, 1.4vw, 12px);

  --container-pad: clamp(8px, 2vw, 14px);

  --radius: 14px;
  --shadow: 0 6px 18px rgba(0,0,0,.22);

  --total-color:#f1f5f9;
  --cycle-accent-light:#ff4d4d;
  --cycle-accent-dark:#ffb347;
  --countdown-red:#ff3333; --adr-color:#2ea0ff;
}
:root[data-theme="light"]{
  color-scheme: light;
  --bg:#f6f8fc; --fg:#111827; --muted:#4b5563;
  --card:#ffffff; --border:#e5e7eb;
  --btn-bg:#ffffff; --btn-fg:#111827; --btn-bd:#d1d5db;
  --total-color:#111111;
  --cycle-accent-light:#ef4444;
}

/* ---------- BASE ---------- */
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg)}
.container{max-width:1200px;margin:0 auto;padding:var(--container-pad)}

/* ---------- HEADER ---------- */
.header{display:grid;gap:var(--gap-xs)}
.controls-row{display:flex;align-items:center;gap:var(--gap-xs);justify-content:space-between}
.brand{justify-self:center;font-weight:900;font-size:var(--title-size);letter-spacing:.2px;text-align:center;margin-top:var(--gap-xs)}
.brand .trial{margin-left:8px;color:#ff3535;font-weight:800;font-size:.55em;white-space:nowrap}

/* Chips */
.chip{display:flex;align-items:center;gap:8px;padding:0 var(--chip-pad-x);height:var(--chip-h);border-radius:12px;background:var(--card);border:1px solid var(--border);color:var(--muted)}
.chip .chip-label{font-weight:800;font-size:var(--subtitle-size);text-transform:uppercase;letter-spacing:.08em}
.chip input[type=number]{width:clamp(56px,10vw,90px);padding:6px 8px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--fg)}
#backChip,#themeChip,#muteChip{background:transparent;border:none;padding:0}
#backBtn.icon-toggle{border:1px solid var(--btn-bd);background:var(--btn-bg);font-size:22px}
.icon-toggle{display:inline-flex;align-items:center;justify-content:center;width:var(--chip-h);height:var(--chip-h);border-radius:12px;border:1px solid var(--btn-bd);background:var(--btn-bg);color:var(--fg)}
.icon-toggle svg{width:clamp(18px,3.2vw,26px);height:clamp(18px,3.2vw,26px)}

/* ---------- TOTAL CPR (tight) ---------- */
.total{grid-area:total;display:flex;flex-direction:column;align-items:center;margin:var(--gap-xs) 0 var(--gap-sm)}
.total .label{font-size:var(--subtitle-size);letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:900;margin-bottom:2px}
.total .digits{font-variant-numeric:tabular-nums;font-family:ui-monospace,Consolas,monospace;font-weight:900;font-size:var(--total-size);color:var(--total-color);line-height:1}

/* ---------- MAIN GRID ---------- */
.main{
  display:grid;
  gap:var(--gap-lg);
  grid-template-areas:
    "total"
    "cycle"
    "adr"
    "actions"
    "wa"
    "log";
  grid-template-columns: 1fr;
  justify-items:center;
}

/* Landscape: Total centered; timers side-by-side; actions split below */
@media (orientation:landscape){
  .main{
    grid-template-areas:
      "total total"
      "cycle adr"
      "actionsL actionsR"
      "wa log";
    grid-template-columns: 1fr 1fr;
    align-items:start;
    justify-items:center;
    row-gap: var(--gap-md);
  }
}

/* ---------- TIMERS (minimal) ---------- */
.timer{
  position:relative;             /* overlay anchor */
  background:transparent;border:none;box-shadow:none;padding:0;margin:0 auto;
  width:min(520px, 100%);
}
.timer .label{
  font-size:var(--subtitle-size);letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:900;margin-bottom:4px;text-align:center
}
.timer .digits{
  font-variant-numeric:tabular-nums;font-family:ui-monospace,Consolas,monospace;font-weight:900;line-height:1;
  font-size:var(--kpi-digits); text-align:left;
}
#cycleDigits{color:var(--cycle-accent-light)}
#adrDigits{color:#2ea0ff}

#cycleTimer{grid-area:cycle}
#adrTimer{grid-area:adr}

/* Start/Pause row (compact) */
.icon-row{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap;justify-content:center}
.icon-ctrl{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid var(--btn-bd);background:var(--btn-bg);color:var(--btn-fg);font-size: clamp(13px, 1.8vw, 16px);font-weight:700}
.icon-ctrl svg{width:22px;height:22px;fill:currentColor}
.icon-ctrl[disabled]{opacity:.45;filter:grayscale(.1);cursor:not-allowed}

/* ---------- OVERLAY CENTER (countdown / adrenaline prompt) ---------- */
.overlay-center{
  position:absolute; left:0; top:0; transform:translate(-50%,-50%);
  pointer-events:none; z-index:2; width:auto; height:auto;
  display:flex; align-items:center; justify-content:center; text-align:center;
}
#countdown{ display:none; font-family:ui-monospace,Consolas,monospace; font-weight:900; line-height:1; color:var(--countdown-red);
  font-size: clamp(80px, min(18vw, 22vh), 180px); text-shadow:0 2px 10px rgba(0,0,0,.28);
}
#countdown.show{ display:flex }
.cycle-hide .label, .cycle-hide #cycleDigits, .cycle-hide .icon-row{ visibility:hidden }

#adrPrompt{ display:none; font-family:ui-monospace,Consolas,monospace; font-weight:900; line-height:1.05; color:var(--adr-color);
  font-size: clamp(36px, min(10vw, 12vh), 96px);
}
#adrTimer.adr-hide .label, #adrTimer.adr-hide #adrDigits, #adrTimer.adr-hide .icon-row{ visibility:hidden }
#adrTimer.adr-show #adrPrompt{ display:flex }

/* ---------- ACTION BUTTONS (smaller) ---------- */
.btn{appearance:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:10px 12px;border-radius:12px;border:1px solid var(--btn-bd);color:#fff;font-weight:800;letter-spacing:.2px;
  font-size: clamp(14px, 1.8vw, 16px);box-shadow:var(--shadow); width:100%; max-width:360px; margin-inline:auto; min-height:42px}
.btn .ico{width:18px;height:18px}
.btn:active{transform:translateY(1px)}
.btn.is-disabled{opacity:.48;filter:grayscale(.2);cursor:not-allowed}
.btn-rosc{ background:linear-gradient(180deg,var(--rosc-1),var(--rosc-2)); border-color:var(--rosc-bd) }
.btn-stop{ background:linear-gradient(180deg,var(--stop-1),var(--stop-2)); border-color:var(--stop-bd) }
.btn-shock{ background:linear-gradient(180deg,var(--shock-1),var(--shock-2)); border-color:var(--shock-bd); color:#1a1a1a }
.btn-amio{ background:linear-gradient(180deg,var(--amio-1),var(--amio-2)); border-color:var(--amio-bd) }
.btn-dsed{ background:linear-gradient(180deg,var(--dsed-1),var(--dsed-2)); border-color:var(--dsed-bd); color:#1a1a1a }
.btn-export{ background:linear-gradient(180deg,var(--export-1),var(--export-2)); border-color:var(--export-bd) }

/* Portrait: 2 columns × 3 rows (dense) */
.actions-wrap{
  grid-area:actions; display:grid; gap:var(--gap-sm);
  grid-template-columns:repeat(2, minmax(140px, 1fr)); justify-items:stretch;
}
.actions-left, .actions-right{display:contents}

/* Landscape: split under each timer (2 columns per side) */
@media (orientation:landscape){
  .actions-wrap{display:contents}
  .actions-left, .actions-right{
    display:grid; gap:var(--gap-sm); grid-template-columns:repeat(2, minmax(140px,1fr)); justify-items:center
  }
  .actions-left{grid-area:actionsL}
  .actions-right{grid-area:actionsR}
}

/* ---------- EXTRAS ---------- */
.extras-wa{grid-area:wa}
.extras-log{grid-area:log}

.wa-shell{width:min(520px, 100%); margin-inline:auto}
.wa-shell details{border:1px solid var(--border); border-radius:12px; background:var(--card); box-shadow:var(--shadow)}
.wa-shell summary{list-style:none; cursor:pointer; user-select:none; padding:10px 12px; font-weight:900; display:flex; align-items:center; justify-content:center; gap:8px}
.wa-shell summary::marker{display:none}
.wa-shell summary .caret{transition:transform .2s ease}
.wa-shell details[open] summary .caret{transform:rotate(90deg)}
.wa-content{padding:10px 12px; border-top:1px solid var(--border)}
.wa-row{display:grid; grid-template-columns:repeat(2, minmax(120px, 1fr)); gap:var(--gap-sm); margin-bottom:6px}
.wa-row input{grid-column:1 / -1; width:100%; padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--fg)}
.btn-wa-m{ background:linear-gradient(180deg,var(--wa-m-1),var(--wa-m-2)); border-color:var(--wa-m-bd) }
.btn-wa-y{ background:linear-gradient(180deg,var(--wa-y-1),var(--wa-y-2)); border-color:var(--wa-y-bd) }

.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 12px; width:min(520px, 100%); box-shadow:var(--shadow); margin-inline:auto}
.log{max-height:220px;overflow:auto;margin:0;padding-left:18px;font-size:clamp(12px, 1.2vw, 13px)}
.log li{margin:6px 0}

/* ---------- PRINT ---------- */
@media print{
  .header,.controls-row,.actions-wrap,.wa-shell{display:none!important}
  body{background:#fff;color:#000}
  .digits{color:#000}
}
@page{ margin:0 }
</style>

<meta name="theme-color" content="#0b0d10" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#f6f8fc" media="(prefers-color-scheme: light)">

<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="controls-row" id="controlsRow">
      <div class="chip" id="backChip">
        <div class="chip-label"></div>
        <button id="backBtn" class="icon-toggle" title="Back">←</button>
      </div>
      <div class="chip" id="themeChip">
        <div class="chip-label">Theme</div>
        <button id="themeBtn" class="icon-toggle" title="Theme: Auto">Auto</button>
      </div>
      <div class="chip" id="bpmChip">
        <div class="chip-label">BPM</div>
        <input id="bpm" type="number" min="60" max="160" step="1" placeholder="110">
      </div>
      <div class="chip" id="muteChip">
        <div class="chip-label">Mute</div>
        <button id="muteBtn" class="icon-toggle" title="Beat mute/unmute" aria-pressed="false">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 9v6h4l5 4V5L7 9H3z" stroke="currentColor" stroke-width="2"/>
            <path id="wave" d="M15 8c1.8 1.2 3 3 3 5s-1.2 3.8-3 5" stroke="currentColor" stroke-width="2" opacity="1"/>
            <path id="muteX" d="M16 9l5 6M21 9l-5 6" stroke="currentColor" stroke-width="2" opacity="0"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="brand">CPR Timer <span class="trial">Trial Version</span></div>
  </div>

  <!-- Total CPR Time -->
  <div class="total">
    <div class="label">TOTAL CPR TIME</div>
    <div id="totalDigits" class="digits">00:00</div>
  </div>

  <!-- Main grid -->
  <main class="main">

    <!-- Timers -->
    <section id="cycleTimer" class="timer">
      <div class="label">CYCLE</div>
      <div id="cycleDigits" class="digits">00:00</div>
      <div id="countdown"></div>
      <div class="icon-row">
        <button id="cprStart" class="icon-ctrl" title="Start/Resume CPR">
          <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg><span>Start</span>
        </button>
        <button id="cprPause" class="icon-ctrl" title="Pause CPR" disabled>
          <svg viewBox="0 0 24 24"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg><span>Pause</span>
        </button>
      </div>
    </section>

    <section id="adrTimer" class="timer">
      <div class="label">ADRENALINE</div>
      <div id="adrDigits" class="digits">00:00</div>
      <div id="adrPrompt">Give Adrenaline</div>
      <div class="icon-row">
        <button id="adrStart" class="icon-ctrl" title="Start/Resume Adrenaline">
          <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg><span>Start</span>
        </button>
        <button id="adrPause" class="icon-ctrl" title="Pause Adrenaline" disabled>
          <svg viewBox="0 0 24 24"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg><span>Pause</span>
        </button>
      </div>
    </section>

    <!-- Actions -->
    <div class="actions-wrap">
      <div class="actions-left">
        <button id="stopb" class="btn btn-stop">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 0 1 7.5 5.25h9a2.25 2.25 0 0 1 2.25 2.25v9a2.25 2.25 0 0 1-2.25 2.25h-9a2.25 2.25 0 0 1-2.25-2.25v-9Z"></path>
          </svg> Stop
        </button>
        <button id="roscb" class="btn btn-rosc">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M12 21C12 21 4 14 4 9a4 4 0 0 1 8 0 4 4 0 0 1 8 0c0 5-8 12-8 12Z" stroke="currentColor" stroke-width="3"/></svg>
          ROSC
        </button>
        <button id="printPdf" class="btn btn-export is-disabled" title="Export PDF (enabled after Stop/ROSC)">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15m0-3-3-3m0 0-3 3m3-3V15"></path>
          </svg> Export PDF
        </button>
      </div>

      <div class="actions-right">
        <button id="shockb" class="btn btn-shock">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M13 2 L3 14h7l-1 8 10-12h-7z" stroke="currentColor" stroke-width="2.5"/></svg>
          Shock
        </button>
        <button id="amiob" class="btn btn-amio">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path>
          </svg> Amiodarone
        </button>
        <button id="dsedb" class="btn btn-dsed" title="Log DSED">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path>
          </svg> Log DSED
        </button>
      </div>
    </div>

    <!-- Extras -->
    <div class="extras-wa">
      <div class="wa-shell">
        <details>
          <summary><span class="caret">▶</span><span>WAAFELSS</span></summary>
          <div class="wa-content">
            <div class="wa-row">
              <input id="age" type="number" min="1" step="1" inputmode="numeric" placeholder="Enter Age">
              <button id="mBtn" class="btn btn-wa-m" title="Months" disabled>Months</button>
              <button id="yBtn" class="btn btn-wa-y" title="Years" disabled>Years</button>
            </div>
            <div class="waffles-grid" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px">
              <div class="wrow"><div class="wtag">Age</div><div id="wAge" class="wval">—</div></div>
              <div class="wrow"><div class="wtag">Weight</div><div id="wWeight" class="wval">—</div></div>
              <div class="wrow"><div class="wtag">Adrenaline</div><div id="wAdr" class="wval">—</div></div>
              <div class="wrow"><div class="wtag">Amiodarone</div><div id="wAmio" class="wval">—</div></div>
              <div class="wrow"><div class="wtag">Fluids</div><div id="wFluids" class="wval">—</div></div>
              <div class="wrow"><div class="wtag">SGA</div><div id="wSGA" class="wval">—</div></div>
              <div class="wrow"><div class="wtag">Energy</div><div id="wJoules" class="wval">—</div></div>
              <div class="wrow"><div class="wtag">D10%</div><div id="wD10" class="wval">—</div></div>
            </div>
          </div>
        </details>
      </div>
    </div>

    <div class="extras-log">
      <div class="card">
        <ul id="log" class="log"></ul>
      </div>
    </div>

  </main>
</div>

<script>
(() => {
/* ===== THEME ===== */
const root = document.documentElement;
const themeBtn = document.getElementById('themeBtn');
let themeMode = 'auto';
function applyTheme(){
  root.removeAttribute('data-theme');
  if (themeMode==='light') root.setAttribute('data-theme','light');
  if (themeMode==='dark')  root.setAttribute('data-theme','dark');
  themeBtn.textContent = themeMode[0].toUpperCase()+themeMode.slice(1);
  themeBtn.title = `Theme: ${themeBtn.textContent}`;
  const meta = document.querySelector('meta[name="theme-color"]')
    || (()=>{const m=document.createElement('meta');m.setAttribute('name','theme-color');document.head.appendChild(m);return m;})();
  requestAnimationFrame(()=>{
    const bg = getComputedStyle(root).getPropertyValue('--bg').trim() || '#0b0d10';
    meta.setAttribute('content', bg);
  });
}
themeBtn.addEventListener('click', () => {
  themeMode = themeMode==='auto' ? 'light' : themeMode==='light' ? 'dark' : 'auto';
  applyTheme();
});
const mql = window.matchMedia('(prefers-color-scheme: dark)');
mql.addEventListener?.('change', ()=>{ if(themeMode==='auto') applyTheme(); });
applyTheme();

/* Back */
const HOME = "https://shortcuts.niwashibase.com/helpers/shortcuts_menu.html";
document.getElementById('backBtn')?.addEventListener('click',()=>{
  if (document.referrer && document.referrer !== location.href) history.back();
  else location.href = HOME;
});

/* ===== HELPERS ===== */
const $ = id => document.getElementById(id);
const fmt = s => { s=Math.max(0,Math.floor(s)); const m=String((s/60|0)).padStart(2,'0'); return `${m}:${String(s%60).padStart(2,'0')}`; };
const hhmmss = d => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false});
const logEl = $('log');
const events = [];
function stamp(label){
  const ts=new Date();
  const li=document.createElement('li');
  li.textContent=`${hhmmss(ts)} | ${label}`;
  logEl.prepend(li);
  events.push({ts,label});
}

/* ===== WAKE LOCK ===== */
let wakeLock=null;
async function requestWake(){try{ if('wakeLock' in navigator){wakeLock=await navigator.wakeLock.request('screen');}}catch{}}
async function releaseWake(){try{ if(wakeLock){await wakeLock.release(); wakeLock=null;}}catch{}}
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && (cprRunning||adrRunning)) requestWake(); });

/* ===== AUDIO ===== */
let audioCtx;
const buffers={}, files={
  beat:'beat.wav', start:'start.wav', pause:'pause.wav', stop:'stop.wav',
  adr4:'adr4.wav', total20:'total20.wav', cpr90:'cpr90.wav', cpr120:'cpr120.wav', rosc:'rosc.wav'
};
function primeAudio(){
  if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
  if (audioCtx.state === 'suspended') { audioCtx.resume().catch(()=>{}); }
  try{ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); g.gain.value=0.0001; o.connect(g).connect(audioCtx.destination); o.start(); setTimeout(()=>{try{o.stop();}catch{}},1);}catch{}
  (async()=>{ for(const [k,p] of Object.entries(files)){ if(buffers[k]) continue; try{ const b=await fetch(p).then(r=>r.arrayBuffer()); buffers[k]=await audioCtx.decodeAudioData(b);}catch{} } })();
}
['pointerdown','touchstart','keydown','click'].forEach(ev=>{ window.addEventListener(ev, primeAudio, {once:true, passive:true}); });
async function ensureAudioReady(){ if(!audioCtx) primeAudio(); if(audioCtx && audioCtx.state==='suspended'){ try{ await audioCtx.resume(); }catch{} } }
function play(name, vol=1){
  const tryBuffer = () => {
    const buf=buffers[name];
    if(!audioCtx || !buf) return false;
    const src=audioCtx.createBufferSource(), g=audioCtx.createGain();
    g.gain.value=vol; src.buffer=buf; src.connect(g).connect(audioCtx.destination); src.start();
    return true;
  };
  const beep = () => {
    try{ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='square'; o.frequency.value=800; g.gain.value=0.08*vol; o.connect(g).connect(audioCtx.destination); o.start(); setTimeout(()=>{try{o.stop();}catch{}},20);}catch{}
  };
  ensureAudioReady().then(()=>{ if(!tryBuffer()) beep(); });
}

/* ===== METRONOME ===== */
let beatMuted=false, beatTimer=null, bpm=+($('bpm').value||110);
$('muteBtn')?.addEventListener('click',()=>{
  beatMuted=!beatMuted;
  const mx=document.getElementById('muteX');
  const wv=document.getElementById('wave');
  if(mx) mx.style.opacity=beatMuted?'1':'0';
  if(wv) wv.style.opacity=beatMuted?'0':'1';
  if(beatMuted) stopBeat(); else if(cprRunning) startBeat();
});
$('bpm')?.addEventListener('change',e=>{ bpm=+e.target.value||110; if(cprRunning) restartBeat(); });

function flashCycle(){ const card=$('cycleTimer'); if(!card) return; card.classList.remove('cycle-flash'); void card.offsetWidth; card.classList.add('cycle-flash'); }
function startBeat(){ clearInterval(beatTimer); const iv=Math.max(200,60000/Math.max(1,bpm)); beatTimer=setInterval(()=>{ if(!beatMuted) play('beat',0.95); flashCycle(); }, iv); }
function stopBeat(){ clearInterval(beatTimer); beatTimer=null; }
function restartBeat(){ stopBeat(); startBeat(); }

/* ===== STATE ===== */
let totalStart=0,totalEnd=0;
let cprStart=0,cprPausedAt=0,cprPausedAccum=0,cprRunning=false;
let adrStart=0,adrPausedAt=0,adrPausedAccum=0,adrRunning=false,adrCount=0;
let cue20=false, cue90=false, cue120=false;
let cycleCount = 0;
let counting=false, countdownTimer=null, countdownN=10;
let showTotalZero = true;

/* ===== OVERLAY CENTERING ===== */
function centerOverlayOverDigits(overlayEl, digitsEl){
  if(!overlayEl || !digitsEl) return;
  overlayEl.classList.add('overlay-center');
  const timer = digitsEl.closest('.timer'); if(!timer) return;
  const tr = timer.getBoundingClientRect();
  const dr = digitsEl.getBoundingClientRect();
  const cx = dr.left + dr.width/2 - tr.left;
  const cy = dr.top  + dr.height/2 - tr.top;
  overlayEl.style.left = `${cx}px`;
  overlayEl.style.top  = `${cy}px`;
}
function alignOverlays(){
  centerOverlayOverDigits(document.getElementById('countdown'), document.getElementById('cycleDigits'));
  centerOverlayOverDigits(document.getElementById('adrPrompt'),  document.getElementById('adrDigits'));
}
window.addEventListener('resize', alignOverlays);
window.addEventListener('orientationchange', alignOverlays);
window.addEventListener('load', alignOverlays);
document.addEventListener('DOMContentLoaded', alignOverlays);

/* ===== COUNTDOWN ===== */
function showCountdown(){
  if(counting) return;
  counting=true; countdownN=10;
  const box=$('countdown'); const card=$('cycleTimer');
  box.textContent=countdownN; box.classList.add('show');
  card.classList.add('cycle-hide');
  alignOverlays();
  stopBeat();
  countdownTimer = setInterval(()=>{
    countdownN--;
    if (countdownN>0){ box.textContent = countdownN; }
    else{
      clearInterval(countdownTimer); countdownTimer=null;
      box.classList.remove('show'); card.classList.remove('cycle-hide');
      cprStart = Date.now(); cprPausedAccum=0; cprPausedAt=0; cue90=false; cue120=false; cprRunning=true; play('start'); if(!beatMuted) startBeat();
      $('cprStart').disabled = true; $('cprPause').disabled = false;
      counting=false;
    }
  },1000);
}

/* ===== TICK ===== */
function now(){ return Date.now(); }
function tick(){
  const t=now();
  // total
  if(showTotalZero){
    $('totalDigits').textContent='00:00';
  }else if(totalStart && !totalEnd){
    $('totalDigits').textContent=fmt((t-totalStart)/1000);
    if(!cue20 && (t-totalStart)>=20*60000){ cue20=true; play('total20'); }
  }else if(totalStart && totalEnd){
    $('totalDigits').textContent=fmt((totalEnd-totalStart)/1000);
  }else{
    $('totalDigits').textContent='00:00';
  }

  // cycle
  let c=0;
  if(cprStart){
    if(cprRunning) c=(t-cprStart-cprPausedAccum)/1000;
    else if(cprPausedAt) c=(cprPausedAt-cprStart-cprPausedAccum)/1000;
    else if(totalEnd) c=(totalEnd-cprStart-cprPausedAccum)/1000;
    c = c|0;
    if(!counting){ $('cycleDigits').textContent=fmt(c); }

    if(!cue90 && c>=90){ cue90=true; play('cpr90'); }
    if(!cue120 && c>=120){
      cue120=true; play('cpr120');
      cycleCount += 1;
      stamp(`Cycle ${cycleCount} finished`);
      cprRunning=false;
      $('cprStart').disabled=false; $('cprPause').disabled=true;
      showCountdown();
    }
  }else{ if(!counting) $('cycleDigits').textContent='00:00'; }

  // adrenaline loop
  if(adrStart){
    let a=0;
    if(adrRunning) a=(t-adrStart-adrPausedAccum)/1000;
    else if(adrPausedAt) a=(adrPausedAt-adrStart-adrPausedAccum)/1000;
    else if(totalEnd) a=(totalEnd-adrStart-adrPausedAccum)/1000;
    a = a|0;
    if(a>=240){
      $('adrDigits').textContent='04:00'; play('adr4');
      stamp('Adrenaline timer reached 4:00');
      const adrCard=$('adrTimer'); adrCard.classList.add('adr-hide','adr-show');
      alignOverlays();
      adrRunning = false;
      setTimeout(()=>{
        adrCard.classList.remove('adr-show','adr-hide');
        adrStart=now(); adrPausedAccum=0; adrPausedAt=0; adrRunning=true;
        $('adrStart').disabled = true; $('adrPause').disabled = false;
      }, 2000);
      a=0;
    }
    $('adrDigits').textContent=fmt(a);
  }else $('adrDigits').textContent='00:00';

  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

/* ===== CONTROLS ===== */
$('cprStart').onclick = () => {
  primeAudio();
  if(!totalStart){
    totalStart=now(); totalEnd=0; showTotalZero=false;
    stamp('CPR Timer Started'); requestWake();
  }
  if(!cprStart){ cprStart=totalStart; cprPausedAccum=0; cue90=false; cue120=false; play('start'); }
  else if(cprPausedAt){ cprPausedAccum += (now()-cprPausedAt); cprPausedAt=0; play('start'); stamp('CPR Timer Resumed'); }
  cprRunning=true; $('cprPause').disabled=false; $('cprStart').disabled=true; if(!beatMuted) startBeat();
};
$('cprPause').onclick = () => {
  if(!cprRunning) return; primeAudio();
  cprRunning=false; cprPausedAt=now(); play('pause'); stamp('CPR Timer Paused'); stopBeat();
  $('cprPause').disabled=true; $('cprStart').disabled=false;
};
$('adrStart').onclick = () => {
  primeAudio(); if(!totalStart) $('cprStart').click();
  if(!adrStart){ adrStart=now(); adrPausedAccum=0; adrPausedAt=0; adrRunning=true; adrCount++; stamp(`Adrenaline no. ${adrCount} Administered`); stamp('Adrenaline Timer Started'); }
  else if(adrPausedAt){ adrPausedAccum += (now()-adrPausedAt); adrPausedAt=0; adrRunning=true; stamp('Adrenaline Timer Resumed'); }
  $('adrPause').disabled=false; $('adrStart').disabled=true;
};
$('adrPause').onclick = () => {
  if(!adrRunning) return; adrRunning=false; adrPausedAt=now(); stamp('Adrenaline Timer Paused');
  $('adrPause').disabled=true; $('adrStart').disabled=false;
};

function endSession(label){
  primeAudio();
  if(!totalStart) return;
  if(!totalEnd) totalEnd = now();
  stamp(label);
  if(cprRunning){ cprRunning=false; cprPausedAt=0; }
  cprStart=0; cprPausedAccum=0; cue90=false; cue120=false; counting=false;
  const cd=$('countdown'); if(cd) cd.classList.remove('show'); $('cycleTimer').classList.remove('cycle-hide');
  $('cprStart').disabled=false; $('cprPause').disabled=true;

  if(adrRunning){ adrRunning=false; adrPausedAt=0; }
  adrStart=0; adrPausedAccum=0;
  $('adrStart').disabled=false; $('adrPause').disabled=true;

  showTotalZero = true;
  stopBeat(); releaseWake();
  setExportEnabled(true);
}
$('stopb').onclick = () => { play('stop'); endSession('CPR Timer Stopped'); };
$('roscb').onclick = () => { play('rosc'); stamp('ROSC Achieved'); endSession('CPR Timer Stopped'); };
$('shockb').onclick = () => { window.__shock=(window.__shock||0)+1; stamp(`Shock no. ${window.__shock} Delivered`); };
$('amiob').onclick  = () => { window.__amio =(window.__amio ||0)+1; stamp(`Amiodarone no. ${window.__amio} Administered`); };
$('dsedb').onclick  = () => { stamp('DSED Delivered'); };

/* ===== EXPORT PDF ===== */
function setExportEnabled(enabled){ $('printPdf').classList.toggle('is-disabled', !enabled); }
setExportEnabled(false);
function sessionEnded(){ return !!(totalStart && totalEnd); }
async function loadScript(src){
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src=src; s.onload=()=>res(); s.onerror=()=>rej(new Error('load '+src));
    document.head.appendChild(s);
  });
}
async function buildPdfBlob(){
  if(!window.jspdf){
    await loadScript('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
  }
  const { jsPDF } = window.jspdf || {};
  if(!jsPDF) throw new Error('jsPDF failed');

  let autoTableLoaded = true;
  if(!jsPDF.API.autoTable){
    try{
      await loadScript('https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js');
    }catch{ autoTableLoaded=false; }
  }

  const doc = new jsPDF({ unit: 'pt' });
  const fmt2 = s => { s=Math.max(0,Math.floor(s)); const m=String((s/60|0)).padStart(2,'0'); return `${m}:${String(s%60).padStart(2,'0')}`; };
  const started = totalStart ? new Date(totalStart).toLocaleString([], {hour12:false}) : 'N/A';
  const ended   = totalEnd ? new Date(totalEnd).toLocaleString([], {hour12:false})   : 'N/A';
  const total   = (totalStart && totalEnd) ? fmt2((totalEnd-totalStart)/1000) : '—';
  const counts  = `Adrenaline: ${adrCount}; Shocks: ${window.__shock||0}; Amiodarone: ${window.__amio||0}`;

  doc.setFont('helvetica','bold'); doc.setFontSize(18);
  doc.text('CPR Session Report', 40, 48);

  doc.setFont('helvetica','normal'); doc.setFontSize(12);
  const kv = [['Started',started],['Ended',ended],['Total',total],['Counts',counts]];
  let y = 74;
  kv.forEach(([k,v])=>{ doc.setFont('helvetica','bold'); doc.text(`${k}:`, 40, y); doc.setFont('helvetica','normal'); doc.text(String(v), 120, y); y += 18; });

  const rows = events.map(e=>[hhmmss(e.ts), e.label]);
  if(autoTableLoaded && doc.autoTable){
    doc.autoTable({ head: [['Time (24h)','Event']], body: rows, startY: y+10, styles: { fontSize: 11, cellPadding: 6 }, headStyles: { fillColor: [25,118,210], textColor: 255 }, alternateRowStyles: { fillColor: [232,244,253] }, margin: { left: 40, right: 40 } });
  }else{
    y += 28; doc.setFont('helvetica','bold'); doc.text('Events:', 40, y); y += 16; doc.setFont('helvetica','normal');
    rows.forEach(r=>{ if (y > 760){ doc.addPage(); y=48; } doc.text(`${r[0]}  |  ${r[1]}`, 40, y); y += 16; });
  }

  const pageCount = doc.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i); doc.setFontSize(10); doc.setTextColor(120);
    doc.text('Ambulance App', 40, doc.internal.pageSize.getHeight()-24);
  }
  return doc.output('blob');
}
function pdfFileName(){
  const d=new Date();
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'), HH=String(d.getHours()).padStart(2,'0'), MM=String(d.getMinutes()).padStart(2,'0');
  return `CPR Report ${yyyy}-${mm}-${dd} ${HH}-${MM}.pdf`;
}
$('printPdf').onclick = async () => {
  if ($('printPdf').classList.contains('is-disabled') || !sessionEnded()){
    alert('Please finish the session first. Tap ROSC or Stop to finalize the report, then export the PDF.');
    return;
  }
  let file;
  try { const blob = await buildPdfBlob(); file = new File([blob], pdfFileName(), { type: 'application/pdf' }); }
  catch (err) { console.error(err); alert('Could not generate the PDF. Please try again.'); return; }
  if (navigator.canShare?.({ files: [file] })) {
    try { await navigator.share({ files: [file], title: 'CPR Session Report', text: 'Generated by Ambulance App' }); }
    catch (err) { console.debug('Share rejected/aborted (ignored):', err); }
  } else { alert('Sharing is not available in this environment.'); }
};

/* ===== WAAFELSS (unchanged logic) ===== */
const age=$('age'), mBtn=$('mBtn'), yBtn=$('yBtn');
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function months(n){
  const weight=n*0.5+4, adr=+(weight*0.01).toFixed(2), amio=+(weight*5).toFixed(1);
  const minF=Math.round(weight*10), maxF=Math.round(weight*20);
  const joules=Math.round(clamp(weight*4,0,360)), d10=+(clamp(weight*2.5,0,50)).toFixed(1);
  const sga=(weight<=5)?'Size 1':'Size 1.5';
  return {age:`${n} months`,weight,adr,amio,minF,maxF,sga,joules,d10};
}
function years(n){
  let weight,sga; if(n<=5){weight=n*2+8; sga=(weight>=10&&weight<=24)?'Size 2':(weight>=25&&weight<=35)?'Size 2.5':'';}
  else{weight=n*3+7; sga=(weight>=25&&weight<=35)?'Size 2.5':'Consider adult SGA sizes';}
  const adr=+(weight*0.01).toFixed(2), amio=+(weight*5).toFixed(1);
  const minF=Math.round(weight*10), maxF=Math.round(weight*20);
  const joules=Math.round(clamp(weight*4,0,360)), d10=+(clamp(weight*2.5,0,50)).toFixed(1);
  return {age:`${n} years`,weight,adr,amio,minF,maxF,sga,joules,d10};
}
function renderW(o){
  $('wAge').textContent=o.age;
  $('wWeight').textContent=`${o.weight.toFixed(1)} kg`;
  $('wAdr').textContent=`${o.adr} mg`;
  $('wAmio').textContent=`${o.amio} mg`;
  $('wFluids').textContent=`${o.minF}–${o.maxF} mL`;
  $('wSGA').textContent=o.sga||'—';
  $('wJoules').textContent=`${o.joules} J`;
  $('wD10').textContent=`${o.d10} mL`;
}
/* Age input validation */
function parseAgeInt(){ const raw=String(age.value??'').trim(); if(raw==='') return NaN; if(raw.includes('.')||raw.includes(',')) return NaN; const n=Number(raw); return Number.isInteger(n)?n:NaN; }
function isPositiveWholeAge(n){ return Number.isInteger(n)&&n>0; }
function validateAgeBasic(showAlert=true){
  const n=parseAgeInt(), ok=isPositiveWholeAge(n);
  if(!ok && showAlert){ alert("Please enter the patient's age as a whole number only.\nAge must be a positive integer — no zero, negatives, or decimals."); }
  return ok? n : NaN;
}
function updateButtonsEnabled(){ const n=parseAgeInt(); const enable=isPositiveWholeAge(n); mBtn.disabled=!enable; yBtn.disabled=!enable; }
age?.addEventListener('input', updateButtonsEnabled); updateButtonsEnabled();
mBtn?.addEventListener('click', ()=>{
  const n=validateAgeBasic(true); if(!isPositiveWholeAge(n)) return;
  if(n>=13){ alert("This age is more than 12 months.\nPlease use the Years button — the Months calculator is for 0–12 months."); return; }
  renderW(months(n));
});
yBtn?.addEventListener('click', ()=>{
  const n=validateAgeBasic(true); if(!isPositiveWholeAge(n)) return;
  if(n>=15){ alert("Our guideline defines pediatric patients up to 14 years."); return; }
  renderW(years(n));
});
})();
</script>
</body>
</html>
