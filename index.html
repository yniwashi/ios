<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ambulance</title>

  <!-- Force a light, white status bar during splash -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#ffffff">

  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; margin: 0; }
    body {
      background: #fff;               /* fallback while image loads */
      overscroll-behavior: none;
      /* safe area so the screenshot looks nice under the system bar */
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* Fullscreen splash */
    #splash {
      position: fixed; inset: 0;
      background: #fff url("/splash.png") center center / cover no-repeat;
      /* If your image has transparency and you want dark in dark mode,
         uncomment the next two lines:
      @media (prefers-color-scheme: dark) {
        background-color: #0f1115;
      }
      */
      opacity: 1;
      transition: opacity 260ms ease-out; /* fade duration */
      z-index: 9999;
    }
    #splash.hide { opacity: 0; pointer-events: none; }

    /* Minimal copy for “Launching…” fallback (rarely seen) */
    #app { display: none; font: 16px system-ui,-apple-system,Segoe UI,Roboto; margin: 3rem; line-height: 1.4; }
    .muted { color: #777; }
    @media (prefers-color-scheme: dark) { .muted { color: #9aa; } }
    #blocked { display: none; font: 16px system-ui,-apple-system,Segoe UI,Roboto; margin: 3rem; line-height: 1.4; }
  </style>
</head>
<body>
  <div id="splash" aria-hidden="true"></div>

  <div id="app">
    <h1>Launching…</h1>
    <p class="muted">Please wait.</p>
  </div>

  <div id="blocked">
    <h1>Access blocked</h1>
    <p>This app is only available when installed on your Home Screen.</p>
  </div>

  <script>
  (async () => {
    const inStandalone =
      (navigator.standalone === true) ||
      (matchMedia && matchMedia('(display-mode: standalone)').matches);

    if (!inStandalone) {
      // Not a web clip/PWA → send to install
      document.getElementById('blocked').style.display = 'block';
      return;
    }

    // Optional: show the splash for a minimum time so the fade feels deliberate.
    const MIN_SPLASH_MS = 1800; // ← adjust how long the splash stays visible
    const t0 = performance.now();

    // If cookie already present, we still show the splash briefly for consistency.
    let hasCookie = false;
    try {
      const r = await fetch('/cookie-check', { credentials: 'include', cache: 'no-store' });
      hasCookie = r.ok && (await r.json()).hasWc;
    } catch {}

    if (!hasCookie) {
      // Mint session
      try {
        const r = await fetch('/session', { method: 'POST', credentials: 'include' });
        if (!r.ok) throw new Error('session failed');
      } catch {
        // fallback – show tiny message
        document.getElementById('app').style.display = 'block';
      }
    }

    // Respect minimum splash duration
    const dt = performance.now() - t0;
    if (dt < MIN_SPLASH_MS) await new Promise(r => setTimeout(r, MIN_SPLASH_MS - dt));

    // Fade out and navigate
    const splash = document.getElementById('splash');
    splash.classList.add('hide');
    setTimeout(() => { location.replace('/ambulance/'); }, 260); // match CSS fade
  })();
  </script>
</body>
</html>
