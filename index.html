<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Ambulance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <!-- iOS standalone bar + theme color (white splash => dark text in the status bar) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta id="apple-bar"   name="apple-mobile-web-app-status-bar-style" content="default">
  <meta id="theme-color" name="theme-color" content="#ffffff">

  <!-- Prevent stale cached splash -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma"        content="no-cache">
  <meta http-equiv="Expires"       content="0">

  <style>
    :root { color-scheme: light dark; }
    /* Full-bleed surface behind everything (white to match splash) */
    html, body {
      height: 100%;
      margin: 0;
      background: #ffffff;
      font: 16px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* --- Splash layer --- */
    .splash {
      position: fixed;
      inset: 0;
      /* SAFARI SAFE-AREA PADDING (keeps image centered nicely if it contains logo) */
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
      background: #ffffff center center / cover no-repeat;
      background-image: url("/images/splash.png"); /* <-- put your file here */
      /* Start visible; we’ll fade to 0 in JS */
      opacity: 1;
      transition: opacity 380ms ease;  /* fade duration */
      z-index: 9999;
    }
    .splash.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* Minimal content blocks (only shown if not standalone) */
    .wrap {
      max-width: 680px;
      margin: 3rem auto;
      padding: 0 1rem;
      line-height: 1.45;
    }
    .muted { color: #666; }
    @media (prefers-color-scheme: dark){
      .muted { color: #9aa6c3; }
    }
    #blocked { display: none; }
    #blocked.show { display: block; }
  </style>
</head>
<body>
  <!-- Fullscreen splash image -->
  <div id="splash" class="splash" aria-hidden="true"></div>

  <!-- Fallback message if opened in Safari (not standalone) -->
  <div id="blocked" class="wrap">
    <h1>Install required</h1>
    <p class="muted">
      This app runs from your Home Screen. You’ll be redirected to the install page…
    </p>
  </div>

  <script>
    // ===== CONFIG =====
    const SPLASH_MIN_MS = 2500; // <-- adjust how long the splash stays visible on each launch
    const DEST = "/ambulance/";

    // Keep status bar consistent with white splash (dark text).
    (function initBar() {
      const themeMeta = document.getElementById('theme-color');
      const appleBar  = document.getElementById('apple-bar');
      if (themeMeta) themeMeta.setAttribute('content', '#ffffff');
      if (appleBar)  appleBar.setAttribute('content', 'default');
    })();

    (async () => {
      // Detect standalone (webclip / PWA)
      const inStandalone =
        (window.navigator.standalone === true) ||
        (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches);

      if (!inStandalone) {
        // Not installed → send to install page (after brief hint)
        document.getElementById('blocked').classList.add('show');
        setTimeout(() => { location.replace('/install/'); }, 800);
        return;
      }

      const splashEl = document.getElementById('splash');
      const start = performance.now();

      // Always mint/refresh the HttpOnly session cookie on launch.
      // We don't wait for it to finish to start the timer; we race with SPLASH_MIN_MS.
      const mint = fetch('/session', { method: 'POST', credentials: 'include', cache: 'no-store' })
        .catch(() => null);

      // Enforce a minimum visible splash duration.
      const sleep = ms => new Promise(r => setTimeout(r, ms));
      const remaining = Math.max(0, SPLASH_MIN_MS - (performance.now() - start));
      await Promise.all([mint, sleep(remaining)]);

      // Smoothly fade out splash, then navigate.
      splashEl.classList.add('hidden');
      // Small delay so the fade completes before Safari snapshot
      setTimeout(() => { location.replace(DEST); }, 420);
    })();
  </script>
</body>
</html>
