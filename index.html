<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ambulance</title>
<style>
  :root { color-scheme: light dark; }
  html, body {
    margin: 0; padding: 0;
    height: 100%; width: 100%;
  }
  body {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
  }
  #splash {
    position: fixed;
    inset: 0;
    background: #000 url('/splash.png') no-repeat center center;
    background-size: cover;
  }
</style>

<div id="splash"></div>

<script>
(async () => {
  // ⚡ Redirect anyone who’s NOT using the Home Screen webclip
  const inStandalone =
    (window.navigator.standalone === true) ||
    (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches);
  if (!inStandalone) {
    window.location.replace('/install/');
    return;
  }

  // ⚡ Optional: keep splash visible for a bit if you want a delay (adjust here)
  const SPLASH_MIN_TIME = 1000; // milliseconds to keep splash on screen
  const start = Date.now();

  // 1) Ask worker if cookie already exists
  let hasCookie = false;
  try {
    const r = await fetch('/cookie-check', { credentials: 'include', cache: 'no-store' });
    if (r.ok) {
      const d = await r.json();
      hasCookie = !!d.hasWc;
    }
  } catch {}

  if (hasCookie) {
    const wait = SPLASH_MIN_TIME - (Date.now() - start);
    if (wait > 0) await new Promise(res => setTimeout(res, wait));
    window.location.replace('/ambulance/');
    return;
  }

  // 2) Mint a new cookie
  try {
    const r = await fetch('/session', { method: 'POST', credentials: 'include' });
    if (!r.ok) throw new Error('session failed');
    const wait = SPLASH_MIN_TIME - (Date.now() - start);
    if (wait > 0) await new Promise(res => setTimeout(res, wait));
    window.location.replace('/ambulance/');
  } catch {
    document.body.innerHTML = '<h1 style="color:white;text-align:center;">Couldn’t start</h1><p style="color:white;text-align:center;">Close and reopen the app.</p>';
  }
})();
</script>
