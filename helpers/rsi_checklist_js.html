<!DOCTYPE html>
<html>
<head>
  <title>SOAPPPME</title>

  <style>
    #soapmetable {
      font-family: Tahoma, sans-serif;
      border-collapse: collapse;
      width: 100%;
      text-align: center;
      margin-left: auto;
      margin-right: auto;
    }

    #soapmetable td, #soapmetable th {
      border: 1px solid #000000;
      padding: 8px;
    }

    #soapmetable tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    #soapmetable th {
      padding-top: 1px;
      padding-bottom: 1px;
      text-align: center;
      background-color: #A1A1A1;
      color: black;
    }

    input[type="checkbox"] {
      transform: scale(1.5);
    }

    #soapmetable .right-align {
      text-align: right;
      font-size: 23px;
      font-weight:bold;
    }

    #soapmetable .left-align {
      text-align: left;
      font-size: 23px;
      font-weight:bold;
    }

    #soapmetable2 {
      font-family: Tahoma, sans-serif;
      border-collapse: collapse;
      width: 100%;
      text-align: center;
      margin-left: auto;
      margin-right: auto;
      margin-top: 50px;
    }

    #soapmetable2 td, #soapmetable2 th {
      border: 1px solid #000000;
      padding: 8px;
    }

    #soapmetable2 tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    #soapmetable2 th {
      padding-top: 1px;
      padding-bottom: 1px;
      font-size: 25px;
      text-align: center;
      background-color: #A1A1A1;
      color: black;
    }

    #soapmetable2 .right-align {
      text-align: right;
      font-size: 18px;
    }

    #soapmetable2 .left-align {
      text-align: left;
      font-size: 18px;
    }

    .hero-img{
      display:block;
      width:100%;
      height:auto;
      margin: 0 auto 30px;
    }

    .si-card{
      margin: 0 0 30px 0;
      padding: 20px;
      background:#fff5f5;
      border:1px solid #f3dcdc;
      border-left:8px solid #e53935;
      border-radius:14px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
      font-family: Tahoma, sans-serif;
    }

    .si-title{
      margin:0 0 10px 0;
      font-size: 36px;
      font-weight:bold;
      color:#b71c1c;
    }

    .si-formula{
      font-size: 29px;
      margin: 10px 0 16px 0;
    }

    .si-list li{
      font-size: 29px;
      padding:12px 14px;
      border:1px solid #f3dcdc;
      border-radius:10px;
      background:#ffffff;
      margin:0 0 12px 0;
    }

    .si-note{
      margin:10px 0 0 0;
      color:#444;
      font-size: 26px;
      line-height:1.5;
    }
    .block-gap{ height: 30px; }

    .countdown-btn{
      display:block;
      margin:16px auto;
      padding:36px 48px;
      font-family:Tahoma, sans-serif;
      font-size:44px;
      font-weight:bold;
      color:#ffffff;
      background: linear-gradient(180deg,#2a66ff,#1447ff);
      border:2px solid #0e2fb3;
      border-radius:20px;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.25);
      text-shadow:0 1px 0 rgba(0,0,0,.25);
    }
    .countdown-btn:hover{ filter: brightness(1.05); }
    .countdown-btn:active{ transform: translateY(1px); }
    .countdown-btn[disabled]{ opacity:.65; cursor:not-allowed; }

    .timer-overlay{
      position:fixed; inset:0;
      background:#ffffff;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index:9999;
      padding:24px;
    }

    .timer-big{
      font-family:Tahoma, sans-serif;
      font-weight:900;
      font-size: clamp(240px, 28vw, 520px);
      line-height:1;
      margin:0 0 40px 0;
      color:#111;
      letter-spacing:2px;
      text-align:center;
    }

    .stop-btn{
      padding:36px 48px;
      font-family:Tahoma, sans-serif;
      font-size:44px;
      font-weight:bold;
      color:#fff;
      background: linear-gradient(180deg,#ff5050,#e53935);
      border:2px solid #a01616;
      border-radius:20px;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.2);
      text-shadow:0 1px 0 rgba(0,0,0,.25);
    }
    .stop-btn:hover{ filter: brightness(1.05); }
    .stop-btn:active{ transform: translateY(1px); }
    .stop-btn[disabled]{ opacity:.65; cursor:not-allowed; }

    .timer{ display:none; font-size:24px; text-align:center; margin-top:8px; }
  </style>

</head>
<body>

<!-- ---------- LIGHT HEADER (RSI) ---------- -->
<style>
  .rsi-header{
    position: sticky; top: 0; z-index: 999;
    background: #FFFFFF; color: #0c1230;
    border-bottom: 1px solid #e7ecf3;
    padding: calc(env(safe-area-inset-top) + 8px) 12px 10px;
  }
  .rsi-row{
    display: flex; align-items: center; justify-content: space-between; gap: 14px;
    max-width: 980px; margin: 0 auto;
  }
  .rsi-back{
    display: inline-flex; align-items: center; justify-content: center;
    width: 56px; height: 56px;
    border-radius: 14px;
    background: #f1f5fb;
    border: 1px solid #e7ecf3;
    color: #0c1230;
    box-shadow: 0 1px 0 rgba(0,0,0,.02);
    -webkit-tap-highlight-color: transparent;
  }
  .rsi-back svg{ width: 28px; height: 28px; }
  .rsi-title{
    margin: 0; flex: 1; text-align: center;
    font-family: Tahoma, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    font-weight: 800; font-size: 30px; line-height: 1.1;
    color: #0c1230;
  }
  .rsi-spacer{ width: 56px; height: 56px; flex: 0 0 56px; }
</style>

<header class="rsi-header" role="banner">
  <div class="rsi-row">
    <button id="backBtn" class="rsi-back" aria-label="Back">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5"/>
      </svg>
    </button>

    <h1 class="rsi-title">RSI Quick Ref. Guide &amp; Checklist</h1>

    <div class="rsi-spacer" aria-hidden="true"></div>
  </div>
</header>

<script>
  // Smart back: history if available, else go home
  const HOME = "https://ios.niwashibase.com/ambulance";
  document.getElementById('backBtn').addEventListener('click', () => {
    if (document.referrer && document.referrer !== location.href && history.length > 1){
      history.back();
    } else {
      location.href = HOME;
    }
  });
</script>

<!-- ===== AUDIO (CPR-style priming, using Web Audio) ===== -->
<script>
let audioCtx;
const audioBuffers = {};
const audioFiles = {
  s30: '../ambulance/audio/sec30.mp3',
  s20: '../ambulance/audio/sec20.mp3',
  s10: '../ambulance/audio/sec10.mp3',
  s5:  '../ambulance/audio/sec5.mp3',
  s4:  '../ambulance/audio/sec4.mp3',
  s3:  '../ambulance/audio/sec3.mp3',
  s2:  '../ambulance/audio/sec2.mp3',
  s1:  '../ambulance/audio/sec1.mp3',
  time: '../ambulance/audio/time.mp3'
};

function primeAudio(){
  try {
    if(!audioCtx){ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    if(audioCtx.state === 'suspended'){ audioCtx.resume().catch(()=>{}); }
    // iOS unlock hack (silent blip)
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    g.gain.value = 0.0001;
    osc.connect(g).connect(audioCtx.destination);
    osc.start();
    setTimeout(()=>{ try{osc.stop();}catch{} }, 1);

    // Preload all files (once)
    (async ()=>{
      for(const [k, url] of Object.entries(audioFiles)){
        if(audioBuffers[k]) continue;
        try{
          const ab = await fetch(url, {cache:'force-cache'}).then(r=>r.arrayBuffer());
          audioBuffers[k] = await audioCtx.decodeAudioData(ab);
        }catch(e){}
      }
    })();
  } catch(e){}
}

async function ensureAudioReady(){
  if(!audioCtx) primeAudio();
  if(audioCtx && audioCtx.state === 'suspended'){
    try{ await audioCtx.resume(); }catch(e){}
  }
}

function playBuffer(key, vol=1){
  const buf = audioBuffers[key];
  if(!audioCtx || !buf) return false;
  try{
    const src = audioCtx.createBufferSource();
    const g = audioCtx.createGain();
    g.gain.value = vol;
    src.buffer = buf;
    src.connect(g).connect(audioCtx.destination);
    src.start();
    return true;
  }catch(e){ return false; }
}

// Fallback beep if buffer isn't ready
function beep(vol=1){
  try{
    if(!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type='square'; o.frequency.value=800;
    g.gain.value = 0.08 * vol;
    o.connect(g).connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ try{o.stop();}catch{} }, 120);
  }catch(e){}
}

function playSecond(n){
  ensureAudioReady().then(()=>{
    const key = 's'+String(n);
    if(!playBuffer(key)) beep();
  });
}

function playTime(){
  ensureAudioReady().then(()=>{
    if(!playBuffer('time')) beep();
  });
}

// Prime on first user interaction (covers iOS)
['pointerdown','touchstart','click','keydown'].forEach(ev=>{
  window.addEventListener(ev, primeAudio, {once:true, passive:true});
});
</script>

<!-- ===== WAKE LOCK (prevent dimming/sleep while timer runs) ===== -->
<script>
let wakeLock = null;
let keepAliveTimer = null; // tiny fallback nudge for older iOS

async function requestWake(){
  try{
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener?.('release', ()=>{ /* released */ });
    } else {
      // Fallback: periodic no-op to keep JS active (helps on some browsers)
      clearInterval(keepAliveTimer);
      keepAliveTimer = setInterval(()=>{ /* noop */ }, 30000);
    }
  }catch(e){
    // ignore
  }
}
async function releaseWake(){
  try{
    if (wakeLock) { await wakeLock.release(); wakeLock = null; }
  }catch(e){}
  clearInterval(keepAliveTimer); keepAliveTimer = null;
}

// Reacquire if tab becomes visible again and timer is running
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState === 'visible' && window.__rsiTimerRunning) {
    requestWake();
  }
});
window.addEventListener('beforeunload', releaseWake);
</script>

<!-- Countdown Button at Top -->
<button class="countdown-btn" id="countdownTop">Start 60s Countdown</button>
<div class="timer" id="timerTop" aria-live="polite"></div>

<!-- Image -->
<img class="hero-img" src="../ambulance/images/rsi_quick_ref.jpg" alt="RSI quick reference" />

<!-- Shock Index card -->
<section class="si-card" aria-label="Shock Index guidance">
  <h2 class="si-title">Shock Index (SI)</h2>
  <div class="si-formula"><strong>Formula:</strong> SI = HR ÷ SBP</div>
  <ul class="si-list">
    <li><strong>Adults:</strong> SI &gt; 0.7</li>
    <li><strong>13–18 years:</strong> SI &gt; 0.9</li>
    <li><strong>8–12 years:</strong> SI &gt; 1.0</li>
  </ul>
  <div class="si-note">
    SI above these thresholds indicates risk of haemodynamic collapse and post-RSI hypotension.
    <strong>Resuscitate prior to RSI.</strong>
  </div>
</section>

<div class="block-gap"></div>

<table id="soapmetable">
  <!-- (your full SOAPPPME table stays unchanged) -->
  <!-- ... -->
</table>

<table id="soapmetable2">
  <!-- (your full dosing table stays unchanged) -->
  <!-- ... -->
</table>

<h6 style="color: black; text-align: right; font-size: 18px; font-family: Tahoma, sans-serif; font-weight: bold;margin-right:15px;margin-top:10px">Version 3.1</h6>

<!-- Countdown Button at Bottom -->
<button class="countdown-btn" id="countdownBottom">Start 60s Countdown</button>
<div class="timer" id="timerBottom" aria-live="polite"></div>

<script>
  (function(){
    const overlay = document.createElement('div');
    overlay.className = 'timer-overlay';
    overlay.innerHTML = `
      <div class="timer-big" id="timerOverlay">01:00</div>
      <button class="stop-btn" id="stopBtn">Stop</button>
    `;
    document.body.appendChild(overlay);

    const overlayTimer = overlay.querySelector('#timerOverlay');
    const stopBtn = overlay.querySelector('#stopBtn');

    const topOut = document.getElementById('timerTop');
    const botOut = document.getElementById('timerBottom');

    const fmt = (sec) => {
      const m = Math.floor(sec / 60).toString().padStart(2,'0');
      const s = (sec % 60).toString().padStart(2,'0');
      return `${m}:${s}`;
    };

    window.__rsiTimerRunning = false;  // shared flag for wake lock
    let interval = null;
    let remaining = 60;

    function setButtonsLabel(text){
      const top = document.getElementById('countdownTop');
      const bottom = document.getElementById('countdownBottom');
      if (top) top.textContent = text;
      if (bottom) bottom.textContent = text;
    }

    function showOverlay(){ overlay.style.display = 'flex'; }
    function hideOverlay(){ overlay.style.display = 'none'; }

    function start(){
      if (window.__rsiTimerRunning) { stop(); return; }
      window.__rsiTimerRunning = true;
      requestWake();                // keep screen on
      ensureAudioReady();           // unlock audio immediately
      setButtonsLabel('Stop 60s');

      remaining = 60;
      overlayTimer.textContent = fmt(remaining);
      if (topOut) { topOut.textContent = fmt(remaining); topOut.style.display = 'block'; }
      if (botOut) { botOut.textContent = fmt(remaining); botOut.style.display = 'block'; }

      showOverlay();

      interval = setInterval(()=>{
        remaining--;
        overlayTimer.textContent = fmt(remaining);
        if (topOut) topOut.textContent = fmt(remaining);
        if (botOut) botOut.textContent = fmt(remaining);

        if ([30,20,10,5,4,3,2,1].includes(remaining)){
          playSecond(remaining);
        }

        if (remaining <= 0){
          playTime();
          stop();
        }
      }, 1000);
    }

    function stop(){
      if (interval) { clearInterval(interval); interval = null; }
      window.__rsiTimerRunning = false;
      releaseWake();                // allow sleep again
      hideOverlay();
      setButtonsLabel('Start 60s Countdown');
      if (topOut) topOut.style.display = 'none';
      if (botOut) botOut.style.display = 'none';
    }

    const topBtn = document.getElementById('countdownTop');
    const botBtn = document.getElementById('countdownBottom');
    if (topBtn) topBtn.addEventListener('click', start);
    if (botBtn) botBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);
  })();
</script>

</body>
</html>
